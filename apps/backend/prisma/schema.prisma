// apps/backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
}

enum ProductionStage {
  CUTTING
  STITCHING
  QUALITY_CHECK
  LABELING
  FOLDING
  PACKING
}

enum BatchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MachineStatus {
  OPERATIONAL
  MAINTENANCE
  OUT_OF_ORDER
}

enum Severity {
  MINOR
  MAJOR
  CRITICAL
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ReworkOutcome {
  CURED
  SCRAPPED
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ReworkStatus {
  PENDING
  COMPLETED
}

enum ReworkStage {
  CUTTING
  STITCHING
}

enum BoxStatus {
  PACKED
  SHIPPED
  DELIVERED
}

// --- Models ---

model User {
  id                 Int                @id @default(autoincrement())
  email              String?            @unique // Optional as login is employeeCode-based
  password           String
  fullName           String
  employeeCode       String             @unique
  role               UserRole           @default(OPERATOR)
  status             UserStatus         @default(ACTIVE)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Hierarchy & Ownership
  createdByUserId    Int?
  verifiedByUserId   Int?
  
  // Relations
  creator            User?               @relation("UserOwnership", fields: [createdByUserId], references: [id])
  createdUsers       User[]              @relation("UserOwnership")
  
  verifier           User?               @relation("UserVerification", fields: [verifiedByUserId], references: [id])
  verifiedUsers      User[]              @relation("UserVerification")

  sectionAssignments SectionAssignment[]
  logsRecorded       ProductionLog[]     @relation("RecordedLog")
  logsPerformed      ProductionLog[]     @relation("PerformedLog")
  defectsDetected    DefectRecord[]
  reworkManaged      ReworkRecord[]      @relation("ManagedRework")
  reworkPerformed    ReworkRecord[]      @relation("PerformedRework")
}

// NOTE: MANAGER users MUST have at least one SectionAssignment (Backend Enforced)
model SectionAssignment {
  id        Int             @id @default(autoincrement())
  userId    Int
  stage     ProductionStage
  createdAt DateTime        @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, stage])
}

model Batch {
  id                Int             @id @default(autoincrement())
  batchNumber       String          @unique
  briefTypeName     String          
  totalQuantity     Int             
  usableQuantity    Int             @default(0) 
  defectiveQuantity Int             @default(0) 
  scrappedQuantity  Int             @default(0) 
  currentStage      ProductionStage @default(CUTTING)
  status            BatchStatus     @default(PENDING)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  productionLogs ProductionLog[]
  defectRecords  DefectRecord[]
  reworkRecords  ReworkRecord[]
  boxes          Box[]
}

model Machine {
  id                  Int           @id @default(autoincrement())
  machineCode         String        @unique
  name                String
  type                String?       
  status              MachineStatus @default(OPERATIONAL)
  location            String?
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  productionLogs ProductionLog[]
}

model ProductionLog {
  id              Int             @id @default(autoincrement())
  batchId         Int
  stage           ProductionStage
  operatorUserId  Int             // The OPERATOR who did the work
  recordedByUserId Int             // The person (Manager/Op/Admin) who logged it
  machineId       Int?
  startTime       DateTime
  endTime         DateTime?
  quantityIn      Int             
  quantityOut     Int?            
  createdAt       DateTime        @default(now())

  // Relations
  batch      Batch    @relation(fields: [batchId], references: [id])
  operator   User     @relation("PerformedLog", fields: [operatorUserId], references: [id])
  recordedBy User     @relation("RecordedLog", fields: [recordedByUserId], references: [id])
  machine    Machine? @relation(fields: [machineId], references: [id])
}

model DefectRecord {
  id              Int             @id @default(autoincrement())
  batchId         Int
  stage           ProductionStage @default(QUALITY_CHECK) 
  defectCode      String
  quantity        Int             
  severity        Severity
  detectedByUserId Int
  createdAt       DateTime        @default(now())

  // Relations
  batch      Batch @relation(fields: [batchId], references: [id])
  detectedBy User  @relation(fields: [detectedByUserId], references: [id])
}

model ReworkRecord {
  id               Int             @id @default(autoincrement())
  batchId          Int
  reworkStage      ReworkStage 
  quantity         Int             
  operatorUserId   Int             // The OPERATOR doing the rework
  managedByUserId  Int             // The MANAGER managing the rework
  status           ReworkStatus    @default(PENDING) 
  outcome          ReworkOutcome?
  curedQuantity    Int             @default(0)
  scrappedQuantity Int             @default(0)
  startTime        DateTime        @default(now())
  endTime          DateTime?
  createdAt        DateTime        @default(now())

  // Relations
  batch     Batch    @relation(fields: [batchId], references: [id])
  operator  User     @relation("PerformedRework", fields: [operatorUserId], references: [id])
  managedBy User     @relation("ManagedRework", fields: [managedByUserId], references: [id])
}

model Box {
  id          Int       @id @default(autoincrement())
  boxCode     String    @unique
  batchId     Int
  quantity    Int       // Must match items inside
  status      BoxStatus @default(PACKED)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  batch Batch @relation(fields: [batchId], references: [id])
}
